<?php
/*
 * Copyright (c) 2012 Fontis Pty. Ltd. (http://www.fontis.com.au)
 * This work is licensed under the Creative Commons Attribution-NoDerivs 3.0 Unported License.
 * To view a copy of this license, visit http://creativecommons.org/licenses/by-nd/3.0/
 * or send a letter to Creative Commons, 444 Castro Street, Suite 900, Mountain View, California, 94041, USA.
 */
?>
<?php define( "l0" ,'https://www.fontis.com.au/mageaudit'); ?>
<?php define( "O0" ,'110'); ?>
<?php class cache_collector { public function l1() { $O1='s'.rand(); mage::app()->getCache()->save($O1,$O1); $l2=mage::app()->getCache()->load($O1); return $l2 == $O1; } public function getCacheData() { $O2=array(); $l3=mage::app(); if (method_exists($l3,'getCacheInstance')) { $O3=$l3->getCacheInstance(); $O2['type']=get_class($O3->getFrontend()->getBackend()); $l4=mage::getModel('core/cache')->getTypes(); $O4=array(); if (is_array($l4)) { foreach ($l4 as $l5 => $O5) { $O4[$l5]=$O5->getData(); } } $O2['types']=$O4; $O2['options']=mage::getResourceSingleton('core/cache')->getAllOptions(); $O2['working']=$this->l1(); } else { $O3=mage::app()->getCache(); $O2['type']=get_class($O3); $O2['types']=array(); $O2['working']=TRUE; $O2['options']=array(); } return $O2; } public function l6() { return $this->getCacheData(); } } ?>
<?php class config_collector { public static function O6($l7) { if ($l7 && trim($l7)) { $l7=trim($l7); $O7=preg_match('/^([0-9]+)\\s*([tgmkb]{1,2})$/i',$l7,$l8); if ($O7 && isset ($l8[1],$l8[2])) { $l7= (int) $l8[1]; $O8=$l8[2]; switch (strtolower($O8)) { case 't': case 'tb': $l7 *= 02000; case 'g': case 'gb': $l7 *= 02000; case 'm': case 'mb': $l7 *= 02000; case 'k': case 'kb': $l7 *= 02000; } } } return $l7; } public function l6() { $l9=mage::getBaseDir().DS.'app'; $O9=mage::getVersion(); $la=array(); $Oa=array(); foreach (get_loaded_extensions() as $lb) { $la[$lb]=phpversion($lb); } if (php_sapi_name() != 'cli') { if ( isset ($_SERVER,$_SERVER['SERVER_SOFTWARE'])) { $Oa['name']=$_SERVER['SERVER_SOFTWARE']; } if (function_exists('apache_get_modules')) { $Oa['modules']=apache_get_modules(); } } $Ob=array(); foreach (ini_get_all() as $l5 => $l7) { $Ob[$l5]=array(); if (is_array($l7)) { foreach ($l7 as $lc => $Oc) { $Ob[$l5][$lc]=$this->O6($Oc); } } else { $Ob[$l5]=$l7; } } $ld=array('test' => 'config','php' => array('version' => phpversion(),'modules' => $la,'config' => $Ob,),'webserver' => $Oa,); if (function_exists('gethostname')) { $ld['hostname']=gethostname(); } if (function_exists('php_uname')) { $ld['uname']=php_uname(); } if (defined( "PHP_OS")) { $ld['php_os']= PHP_OS; } return $ld; } } ?>
<?php class database_collector { public function l6() { $l9=mage::getBaseDir().DS.'app'; try { $Od=mage::getModel('core/config')->getTablePrefix(); } catch (exception $le) { $Od=''; } $Oe=array(); $lf=mage::getSingleton('core/resource')->getConnection('core_read'); $l2=$lf->fetchall("SH\117\127 T\101B\114\105S\073"); $Of=array(); foreach ($l2 as $lg) { $l7=current($lg); try { $Og= "\123HOW\040C\122E\101\124\105\040\124\101B\114E\040`{$l7}\140;"; $lh=$lf->fetchall($Og); $Oe[$l7]=$lh[0]["Cr\145\141te\040\124a\142\154\145"]; } catch (exception $le) { $Of[]=$le->getmessage(); } } $l2=$lf->fetchall("\123\110OW \126A\122IA\102\114\105S\073"); foreach ($l2 as $lg) { $Oh[$lg['Variable_name']]=$lg['Value']; } $ld=array('test' => 'database','prefix' => $Od,'schema' => $Oe,'config' => $Oh,'errors' => $Of,); return $ld; } } ?>
<?php class files_collector { protected function Oi($lj) { libxml_use_internal_errors(TRUE); $Oj=new domdocument('1.0','utf-8'); $Oj->load(realpath($lj)); $Of=libxml_get_errors(); libxml_clear_errors(); if (!empty($Of)) { foreach ($Of as $lk) { $code=$lk->code; $level=$lk->level; $message=$lk->message; unset ($lk); if ($level>2) { return TRUE; } } } return FALSE; } protected function Ok($ll) { $lj=array(); foreach ($ll as $lm) { if (preg_match('/\\.xml$/',$lm)) { if ($this->Oi($lm)) { $lj[]=$lm; } } } return $lj; } protected function Om($ln) { $On=array(); if ($lo=opendir($ln)) { while (FALSE !== ($lm=readdir($lo))) { if ($lm != '.' && $lm != '..' && $lm != 'var') { $l9=$ln.'/'.$lm; if (is_dir($l9)) { $On=array_merge($On,$this->Om($l9)); } else { $On[$l9]=$l9; } } } closedir($lo); } return $On; } protected function Oo($ll) { $lp=array(); if (is_array($ll) && count($ll)) { foreach ($ll as $Op => $O2) { $lp[$Op]=array('md5' => md5_file($O2),'permissions' => sprintf('%o',fileperms($O2))); } } return $lp; } protected function lq($On,$Oq) { $lp=array(); if (is_array($On) && count($On)) { foreach ($On as $Op => $O2) { $lr=str_replace($Oq,'.',$Op); $lp[$lr]=$O2; } } return $lp; } public function l6() { $l9=mage::getBaseDir(); $ls=array($l9.DS.'app',$l9.DS.'lib',$l9.DS.'js',$l9.DS.'skin'); $On=array(); foreach ($ls as $Os) { $On=array_merge($On,$this->Om($Os)); } $lj=$this->lq($this->Ok($On),$l9); $On=$this->lq($this->Oo($On),$l9); $ld=array('test' => 'md5sum','path' => $l9,'files' => $On,'xml' => $lj,); return $ld; } } ?>
<?php class magento_collector { public function getId() { $lt=mage::getStoreConfig('fontis/info/id'); if (!$lt) { $lt=uniqid(); mage::getModel('core/config')->saveConfig('fontis/info/id',$lt); } return $lt; } public function Ot() { $lu= (array) mage::getConfig()->getNode('modules'); $Ou=array('id' => $this->getId(),'Core' => mage::getVersion(),); foreach ($lu as $code => $O2) { $O2= (array) $O2; $Ou[$code]= isset ($O2['version']) ? $O2['version']: 'N/A'; } return $Ou; } public function l1() { $O1='s'.rand(); mage::app()->getCache()->save($O1,$O1); $l2=mage::app()->getCache()->load($O1); return $l2 == $O1; } public function getCacheData() { $O2=array(); $l3=mage::app(); if (method_exists($l3,'getCacheInstance')) { $O3=$l3->getCacheInstance(); $O2['type']=get_class($O3->getFrontend()->getBackend()); $l4=mage::getModel('core/cache')->getTypes(); $O4=array(); if (is_array($l4)) { foreach ($l4 as $l5 => $O5) { $O4[$l5]=$O5->getData(); } } $O2['types']=$O4; $O2['options']=mage::getResourceSingleton('core/cache')->getAllOptions(); $O2['working']=$this->l1(); } else { $O3=mage::app()->getCache(); $O2['type']=get_class($O3); $O2['types']=array(); $O2['working']=TRUE; $O2['options']=array(); } return $O2; } public function lv() { $O2=array(); $Ov=mage::getSingleton('core/session'); $O2['method']=$Ov->getSessionSaveMethod(); $O2['path']=$Ov->getSessionSavePath(); $O2['validate']=$Ov->validate(); return $O2; } public function getConfig() { $Oh=array(); $lf=mage::getSingleton('core/resource')->getConnection('core_read'); $l2=$lf->fetchall("s\145\154e\143t\040* \146\162\157\155 ".mage::getSingleton('core/resource')->getTableName('core_config_data')); foreach ($l2 as $lg) { if (!preg_match('/pass/i',$lg['value'])) { $Oh[$lg['path']]=$lg['value']; } } return $Oh; } public function lw() { $O2=array(); $O2['enabled_products']=mage::getModel('catalog/product')->getCollection()->addAttributeToFilter('status',1)->count(); $O2['total_products']=mage::getModel('catalog/product')->getCollection()->count(); return $O2; } public function Ow() { $O2=array(); $O2['websites']=mage::getModel('catalog/product')->getCollection()->addAttributeToFilter('status',1)->count(); $O2['groups']=mage::getModel('catalog/product')->getCollection()->count(); $O2['stores']=mage::getModel('catalog/product')->getCollection()->count(); return $O2; } public function l6() { $Oh=$this->getConfig(); $lu=$this->Ot(); $O3=$this->getCacheData(); $Ov=$this->lv(); $lx=$this->lw(); $Ox=$this->Ow(); $ld=array('test' => 'magento','config' => $Oh,'modules' => $lu,'cache' => $O3,'session' => $Ov,'products' => $lx,'stores' => $Ox,); return $ld; } } ?>
<?php $ly=ini_set('memory_limit','2G'); $Oy=ini_set('max_execution_time','0'); function lz() {; ?>
<!DOCTYPE html><html lang="en">  <head>    <meta charset="utf-8">    <title>MageAudit by Fontis</title>    <meta name="description" content="">    <meta name="author" content="">    <!--[if lt IE 9]>      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>    <![endif]-->    <link href="<?php echo l0; ?>/css/bootstrap.css" rel="stylesheet">    <link href="<?php echo l0; ?>/css/font.css" rel="stylesheet">    <link href="<?php echo l0; ?>/css/site.css" rel="stylesheet">    <link href="<?php echo l0; ?>/css/bootstrap-responsive.css" rel="stylesheet">    <link href="<?php echo l0; ?>/css/font-awesome.css" rel="stylesheet">    <link href="<?php echo l0; ?>/css/proxima/stylesheet.css" rel="stylesheet">    <link rel="shortcut icon" href="<?php echo l0; ?>/images/favicon.ico">    <link rel="apple-touch-icon" href="<?php echo l0; ?>/images/apple-touch-icon.png">    <link rel="apple-touch-icon" sizes="72x72" href="<?php echo l0; ?>/images/apple-touch-icon-72x72.png">    <link rel="apple-touch-icon" sizes="114x114" href="<?php echo l0; ?>/images/apple-touch-icon-114x114.png">  </head>  <body class="collector">    <div id="sticky-container">    <div class="navbar navbar-fixed-top">      <div class="navbar-inner">        <div class="container">         <div class="row">          <div class="span4">           <a class="brand" href="<?php echo l0; ?>/"><i class="icon-ok-sign"></i> MageAudit <sup>By Fontis</sup></a>          </div>          <div class="span8">           <div class="pagination">             <ul>               <li class="active"><a href="?s=Step1">1. Run Audit</a></li>               <li><a href="">2. Unlock</a></li>               <li><a href="">3. View Report</a></li>             </ul>           </div>          </div>         </div>        </div>      </div>    </div>    <div class="container" id="main"><?php } function Oz() {; ?>
    </div>    <div id="root-footer"></div>    </div>        <footer class="navbar navbar-fixed-top" id="page-footer">      <div class="navbar-inner">        <div class="container">          <a class="brand" href="<?php echo l0; ?>/"><i class="icon-ok-sign"></i> MageAudit By <strong>Fontis</strong></a>          <nav>            <ul class="nav" id="primary-nav"> <li><a href="<?php echo l0; ?>/contact">Contact</a></li>            </ul>          </nav>        </div>      </div>    </footer>    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>    <script src="<?php echo l0; ?>/js/spin.min.js"></script>    <script src="<?php echo l0; ?>/js/audit.js"></script>    <script src="<?php echo l0; ?>/js/bootstrap.js"></script>    <script src="<?php echo l0; ?>/js/bootstrap-transition.js"></script>    <script src="<?php echo l0; ?>/js/bootstrap-tooltip.js"></script>    <script src="<?php echo l0; ?>/js/bootstrap-popover.js"></script>    <script src="<?php echo l0; ?>/js/prettify.js"></script>    <script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.9/jquery.validate.min.js"></script>  </body></html>
<?php } function content() {; ?>
<div id="form"><form class="well feature form-inline must-validate" action="<?php echo basename( __FILE__); ?>" method="post">    <h1>Enter your email address to receive your Audit Report</h1>    <div id="collector-email-wrapper">        <input type="text" class="input-xlarge email required" name="email" value="" />    </div>    <input type="submit" class="btn-large btn-primary" name="" value="Begin Audit" id="begin-audit" />    <p><i class="icon-time"></i> The audit will take approximately 5 minutes.</p></form></div><div id="loading" style="display:none">    <div class="well feature form-inline">        <h1>Thanks. Please wait while your audit runs.</h1>        <p class="throbber"></p>        <p><i class="icon-time"></i> The audit will take approximately 5 minutes.</p>    </div>    </div><div id="error"></div>
<?php } class l10 { public $O10=''; public $l11=""; protected $O11=array('magento','files','database','cache','config',); protected $l12=l0; public function O12($l12,$O2,$l13=0120) { $O13=curl_init(); if (substr($l12,0,5) == 'https' && $l13 == 0120) { $l13=0673; } else if (substr($l12,0,5) == 'http:' && $l13 == 0673) { $l13=0120; } curl_setopt($O13,CURLOPT_URL,$l12); curl_setopt($O13,CURLOPT_PORT,$l13); curl_setopt($O13,CURLOPT_RETURNTRANSFER,1); curl_setopt($O13,CURLOPT_SSL_VERIFYPEER,FALSE); if ($O2) { curl_setopt($O13,CURLOPT_POST,1); curl_setopt($O13,CURLOPT_HTTPHEADER,array('Content-type: text/json',"\103o\156t\145n\164\055\154\145\156gt\150:\040".strlen($O2))); curl_setopt($O13,CURLOPT_POSTFIELDS,$O2); } $l14=curl_exec($O13); $O2=curl_getinfo($O13); if ($l14 === FALSE || curl_errno($O13)) { $le=new exception(curl_error($O13)); curl_close($O13); throw $le; } curl_close($O13); return (string) $l14; } public function O14($l12,$O2,$l13=0673) { return $this->O12($l12,$O2,$l13); } public function get($l12,$l13=0120) { return $this->O12($l12,NULL,$l13); } public function l15() { $O9=O0; $O15=$this->get( "{$this->l12}/\141ud\151t\057\166e\162\163\151\157\156"); if ( (int) $O15 && (int) $O15> (int) $O9) { return FALSE; } return TRUE; } public function l16() { return $this->getInterface() != 'cli'; } public function O16() { $l17=array(); if (!$this->l15()) { $l17[]= "\124h\151s\040\166\145r\163\151\157\156\040\157\146 \164\150\145 \141u\144i\164\040s\143\162\151\160\164\040\151\163\040a\143\164\165al\154y\040\157u\164 \157\146 \144a\164e\054 \141nd\040a\040mo\162e\040rec\145nt\040ver\163ion\040is av\141ilable.\040Please \147o\040\164o\040<\141\040h\162e\146=\042{$this->l12}\042\076{$this->l12}\074/\141\076 \141\156\144 \144\157\167\156\154\157\141d\040\151t\040t\157\040\143\157\156\164\151\156\165\145\056"; } if ((version_compare(phpversion(),'5.1','<'))) { $l17[]="\114\157\157k\163\040\154i\153\145\040\171\157\165\162 \166\145\162s\151\157\156\040\157\146\040\120\110\120\040\151s\040\141\040\142it\040t\157\157 \157\154d\040t\157 \162u\156 \164h\151s \163c\162ip\164 (\157r M\141ge\156to \146or th\141t matt\145r). Ple\141s\145 \164\162y\040a\147\141i\156\040w\151t\150\040a\040v\145\162s\151o\156 \157\146 \120H\120 \076 \065.\061."; } if (!function_exists('curl_init')) { $l17[]="\131\157\165'l\154\040\156e\145\144\040\164\157\040\151n\163\164a\154\154\040\164\150\145\040\160\150\160\040\143\165r\154\040\145\170t\145n\163i\157\156 \164\157 \143o\156t\151n\165e.\040S\145e\072 <\141 hr\145f=\042htt\160://\167ww.ph\160.net/m\141nual/e\156/\143u\162\154.\163\145t\165\160.\160\150p\042>\150\164t\160\072/\057w\167w\056p\150p\056n\145\164/\155a\156u\141l\057e\156/\143u\162l\056s\145t\165p\056p\150p\074/a\076 \146o\162 \151n\163tr\165c\164i\157ns"; } return $l17; } public function O17($l9) { $l18=$l9.'/app/Mage.php'; $O18=glob($l18); if (!$O18 || !is_array($O18) || !count($O18)) { return FALSE; } return TRUE; } public function getInterface() { return php_sapi_name(); } public function getVersion() { $O9=mage::getVersion(); $l19='ce'; if (version_compare($O9,'1.6.0.0','>=')) { $O19=mage::getModel('enterprise_giftcard/giftcard'); if ($O19) { $l1a=mage::getModel('enterprise_search/observer'); if ($l1a) { $l19='ee'; } else { $l19='pe'; } } else { $l19='ce'; } } return $l19.$O9; } public function O1a($l1b) { include ( "$l1b\057a\160p\057\115a\147\145\056\160\150p"); mage::app(); $O1b=array(); foreach ($this->O11 as $l1c) { $O1c=$l1c.'_collector'; if (class_exists($O1c,FALSE)) { try { $l1d=new $O1c; $O1b[$l1c]=$l1d->l6(); } catch (exception $le) { $O1b[$l1c]=array('error' => "E\170\143e\160t\151\157\156\072\040".$le->__tostring()); } } else { $O1b[$l1c]=array('error' => "\124e\163t\040\047$l1c\047\040\167a\163 \156\157\164 \146\157un\144"); } } global $ly; global $Oy; if ($Oy !== FALSE) { $O1b['config']['php']['config']['max_execution_time']['local_value']=$Oy; } if ($ly !== FALSE) { $O1b['config']['php']['config']['memory_limit']['local_value']=$ly; } $lp=json_encode(array('email_address' => $this->O10 ,'general_info' => array('version' => O0,'base_url' => mage::getBaseUrl(),'magento_version' => $this->getVersion(),),'test_responses' => $O1b,'interface' => $this->getInterface(),)); return $this->O14($this->l12.'/audit/',gzcompress($lp)); } } $O1d=new l10(); $O10=''; $l9=''; $l1e=FALSE; $l17=$O1d->O16(); if (count($l17)) { foreach ($l17 as $O1e) { echo "$O1e"; } exit; } if (!$O10 || !$l9) { if (class_exists('Mage')) { $l9=mage::getBaseDir(); if (mage::getStoreConfig('fontis_extensions/audit/email')) { $O10=mage::getStoreConfig('fontis_extensions/audit/email'); } } else { if (!$O1d->l16()) { if (count($argv) != 3) { echo "\125s\141\147e\072\040p\150\160\040-\146\040".__FILE__." \155a\147e\156t\157\137\160a\164\150\040\145\155\141i\154\137\141d\144\162\145\163\163\n\n"; exit; } $l9=$argv[1]; $O10=$argv[2]; if (!$O1d->O17($l9)) { echo "T\150i\163 \160a\164\150\040\144\157\145\163n\047\164\040\154\157\157k\040\154\151\153\145\040\141\040\115\141\147\145\156t\157 in\163t\141l\154\141t\151\157n\056 \120l\145a\163e\040p\157in\164 \164he\040sc\162ip\164 at\040the\040root \157f your\040Magento\040d\151\162e\143t\157\162\171 \050i\056\145.\040W\150\145r\145\040t\150e\040i\156\144e\170.\160\150p\040f\151l\145 \151s\054 \141\154o\156g\040w\151t\150 \164h\145 \141pp\054 \163k\151n\040&\040va\162 \146o\154d\145rs\051.\n"; exit (); } } else { if ( isset ($_REQUEST,$_REQUEST['email']) && $_REQUEST['email']) { $O10=$_REQUEST['email']; if ( isset ($_REQUEST['path'])) { $l9=$_REQUEST['path']; } else { $l9='.'; } if ( isset ($_REQUEST['useajax'])) { $l1e=TRUE; } else { $l1e=FALSE; } } else { if (!$O1d->O17('.')) { echo "\124\150\151s\040\144\157\145s\156'\164\040\154o\157\153\040\154\151k\145\040\141\040\115\141\147\145\156\164\157 \151\156\163t\141\154la\164\151o\156\056 \120l\145\141s\145 \160l\141ce\040t\150is\040sc\162i\160t i\156 th\145 ro\157t of\040your Ma\147ento \144ir\145c\164\157\162y\040(\151\056e\056 \127\150e\162\145 \164h\145 \151\156d\145x\056p\150\160 \146i\154e\040i\163,\040a\154o\156g\040w\151t\150 \164h\145 \141p\160, \163k\151n\040&\040va\162 \146o\154de\162s\051."; exit (); } echo lz(); echo content(); echo Oz(); exit (); } } } } $O1d->O10 =$O10; $l1f=$O1d->O1a($l9); if (substr(trim($l1f),0,4) == 'http') { if (!$O1d->l16()) { echo "Pl\145\141s\145 \160\162o\143\145\145\144\040\164\157:\040$l1f\040\164o\040v\151\145w\040\171\157\165r\040\162\145\160\157\162\164"; } else { if ($l1e) { echo json_encode(array('error' => FALSE,'location' => trim($l1f))); } else { header('Location: '.trim($l1f)); echo "\074s\143r\151p\164\040\164y\160\145\075\042\164\145\170\164/\152a\166\141\163\143\162\151\160\164\042\076w\151\156\144\157\167.loc\141\164i\157\156=\047$l1f'\073\074/\163c\162\151p\164\076\120\154\145\141s\145\040\160\162o\143\145\145\144\040\164\157\072\040\074\141 \150\162\145f\075\042$l1f\042\076$l1f</\141>"; } }@unlink(__file__); } else { if ($O1d->l16() && $l1e) { $message='
        <div id="error-well" class="well feature form-inline">
            <div class="row-fluid">
                <div class="span2">&nbsp;</div>
                <div class="span1"><i class="fail icon-exclamation-sign"></i></div>
                <div class="span7">'.$l1f.'
                </div>
                <div class="span2">&nbsp;</div>
            </div>
        </div>'; echo json_encode(array('error' => TRUE,'message' => $message)); } else { echo $l1f; } } ?>
